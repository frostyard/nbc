---
phase: 01-testing-reliability
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - pkg/testutil/incus.go
  - pkg/testutil/golden.go
autonomous: true

must_haves:
  truths:
    - "IncusFixture can connect to local Incus socket"
    - "IncusFixture creates VMs with unique names per test"
    - "IncusFixture cleanup runs even on test failure"
    - "Golden file helper normalizes timestamps and UUIDs"
  artifacts:
    - path: "pkg/testutil/incus.go"
      provides: "Incus test fixture for VM management"
      exports: ["IncusFixture", "NewIncusFixture"]
      min_lines: 100
    - path: "pkg/testutil/golden.go"
      provides: "Golden file testing utilities"
      exports: ["NewGolden", "NormalizeOutput"]
      min_lines: 40
  key_links:
    - from: "pkg/testutil/incus.go"
      to: "github.com/lxc/incus/v6/client"
      via: "import and ConnectIncusUnix"
      pattern: "incus\\.ConnectIncusUnix"
    - from: "pkg/testutil/golden.go"
      to: "github.com/sebdah/goldie/v2"
      via: "import and goldie.New"
      pattern: "goldie\\.New"
---

<objective>
Create the core test fixtures: IncusFixture for VM management and golden file helpers for CLI output testing.

Purpose: These are the foundational components that all VM tests and CLI output tests will use.
Output: Two new files in pkg/testutil/ providing structured test infrastructure.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-testing-reliability/01-RESEARCH.md
@.planning/phases/01-testing-reliability/01-CONTEXT.md
@pkg/testutil/disk.go
@pkg/testutil/timeouts.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Incus test fixture</name>
  <files>pkg/testutil/incus.go</files>
  <action>
Create `pkg/testutil/incus.go` with IncusFixture struct following patterns from RESEARCH.md:

Key components:
1. **IncusFixture struct**: Wraps incus.InstanceServer client with test-specific helpers
2. **NewIncusFixture(t *testing.T)**: 
   - Connects to local Incus unix socket via `incus.ConnectIncusUnix("", nil)`
   - Generates unique VM name: `fmt.Sprintf("nbc-test-%s-%d", sanitize(t.Name()), os.Getpid())`
   - Registers t.Cleanup() BEFORE creating any resources
   - Returns fixture or skips test if Incus unavailable
3. **Cleanup()**: 
   - Force stop VM (ignore errors)
   - Delete VM (ignore errors)
   - Delete storage volume if created (ignore errors)
   - All cleanup is best-effort, silent on failure (per CONTEXT.md)
4. **CreateVM(image string)**: Launch VM with standard config (4 CPU, 16GiB RAM, secureboot=false)
5. **WaitForReady(ctx context.Context)**: Poll `systemctl is-system-running --wait` with timeout
6. **ExecCommand(command ...string) (string, error)**: Execute command in VM, return stdout
7. **PushFile(local, remote string)**: Push file to VM
8. **AttachDisk(volumeName string, size string)**: Create and attach block storage volume

Use api types from `github.com/lxc/incus/v6/shared/api` for InstancesPost, InstanceStatePut, etc.

Helper function `sanitize(name string)` to make test names safe for VM names (replace / with -, lowercase).
  </action>
  <verify>
```bash
go build ./pkg/testutil/...
```
Build should succeed. Note: Cannot test actual Incus connection without root/incus.
  </verify>
  <done>pkg/testutil/incus.go compiles, exports IncusFixture with all documented methods</done>
</task>

<task type="auto">
  <name>Task 2: Create golden file helpers</name>
  <files>pkg/testutil/golden.go</files>
  <action>
Create `pkg/testutil/golden.go` with golden file testing utilities:

1. **NewGolden(t *testing.T) *goldie.Goldie**: 
   - Configured with WithFixtureDir("testdata")
   - WithNameSuffix(".golden")
   - WithDiffEngine(goldie.ColoredDiff)

2. **NormalizeOutput(s string) string**: Normalize dynamic content before comparison:
   - Replace ISO timestamps with "TIMESTAMP" 
   - Replace UUIDs with "UUID"
   - Replace /dev/loopN with "/dev/loopN"
   - Replace /tmp/... paths with "/tmp/..."
   - Preserve ordering and structure

3. **AssertGolden(t *testing.T, name string, actual []byte)**: Wrapper that normalizes and asserts

Pattern from RESEARCH.md:
```go
func NormalizeOutput(s string) string {
    // Replace timestamps: 2024-01-15T10:30:45Z -> TIMESTAMP
    s = regexp.MustCompile(`\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[Z+-][\d:]*`).
        ReplaceAllString(s, "TIMESTAMP")
    // Replace UUIDs
    s = regexp.MustCompile(`[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}`).
        ReplaceAllString(s, "UUID")
    // Replace loop devices
    s = regexp.MustCompile(`/dev/loop\d+`).
        ReplaceAllString(s, "/dev/loopN")
    return s
}
```

Usage: `go test -update ./...` regenerates golden files.
  </action>
  <verify>
```bash
go build ./pkg/testutil/...
```
Build should succeed.
  </verify>
  <done>pkg/testutil/golden.go compiles, exports NewGolden, NormalizeOutput, AssertGolden</done>
</task>

</tasks>

<verification>
1. `go build ./pkg/testutil/...` succeeds
2. IncusFixture has: NewIncusFixture, Cleanup, CreateVM, WaitForReady, ExecCommand, PushFile, AttachDisk
3. Golden helpers have: NewGolden, NormalizeOutput, AssertGolden
4. Code follows existing patterns in disk.go (t.Helper(), t.Cleanup() registration)
</verification>

<success_criteria>
- IncusFixture connects to Incus and manages VM lifecycle
- Cleanup is registered via t.Cleanup() before resource creation
- Golden file helper normalizes timestamps, UUIDs, loop devices
- All code compiles and follows existing testutil conventions
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-reliability/01-02-SUMMARY.md`
</output>
