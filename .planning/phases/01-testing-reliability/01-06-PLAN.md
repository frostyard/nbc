---
phase: 01-testing-reliability
plan: 06
type: execute
wave: 6
depends_on: ["01-05"]
files_modified:
  - test_incus.sh
  - test_incus_quick.sh
  - test_incus_encryption.sh
  - test_incus_loopback.sh
  - test_integration.sh
  - Makefile
autonomous: false

must_haves:
  truths:
    - "make test-integration passes 3 consecutive times"
    - "No orphaned VMs, volumes, or mounts after test run"
    - "Bash test scripts are deleted"
    - "Makefile points test-incus to Go tests"
  artifacts:
    - path: "Makefile"
      provides: "Updated test targets"
      contains: "test-incus-go"
  key_links: []
---

<objective>
Finalize test migration: delete bash scripts, update Makefile, verify deterministic execution.

Purpose: Complete the phase by removing legacy code and validating the new test infrastructure meets all requirements.
Output: Clean codebase with Go-only tests, verified 3x consecutive pass.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-testing-reliability/01-CONTEXT.md
@pkg/incus_test.go
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Makefile test targets</name>
  <files>Makefile</files>
  <action>
Update Makefile to use Go-based tests as the primary targets:

1. **Update test-incus** to call Go tests instead of bash:
```makefile
test-incus: test-incus-go ## Run Incus VM integration tests (Go-based)
```

2. **Remove or deprecate bash script targets**:
   - Comment out _test-incus target that calls ./test_incus.sh
   - Keep test-incus-go as the implementation

3. **Update test target** to include VM tests when run with incus available:
```makefile
test: test-unit test-integration ## Run all tests (unit then integration)
	@echo "Note: For VM tests, run 'make test-incus' (requires root + incus)"
```

4. **Remove test-incus-quick, test-incus-encryption targets** (these will be Go tests or removed)
  </action>
  <verify>
```bash
make help | grep -E "test-incus|test-integration"
```
Should show test-incus target pointing to Go tests.
  </verify>
  <done>Makefile uses Go-based test-incus target, old bash targets removed</done>
</task>

<task type="auto">
  <name>Task 2: Delete legacy bash test scripts</name>
  <files>test_incus.sh, test_incus_quick.sh, test_incus_encryption.sh, test_incus_loopback.sh, test_integration.sh</files>
  <action>
Remove the legacy bash test scripts:

```bash
rm -f test_incus.sh
rm -f test_incus_quick.sh
rm -f test_incus_encryption.sh
rm -f test_incus_loopback.sh
rm -f test_integration.sh
```

These scripts are replaced by:
- test_incus.sh -> pkg/incus_test.go (TestIncus_*)
- test_incus_quick.sh -> pkg/incus_test.go (TestIncus_Install)
- test_incus_encryption.sh -> Encryption coverage explicitly deferred (see note below)
- test_incus_loopback.sh -> pkg/integration_test.go (existing loopback tests)
- test_integration.sh -> make test-integration (existing Go tests)

**IMPORTANT: Encryption test coverage decision**
Before deleting test_incus_encryption.sh:
1. Review its contents to identify unique test scenarios
2. If it tests LUKS encryption during install, verify this is covered by TestIncus_Install
   with encryption flag or document as deferred to Phase 2
3. If encryption tests are NOT covered by current Go tests, add a TODO comment in
   pkg/incus_test.go: `// TODO(phase-2): Add TestIncus_Encryption for LUKS support`

This ensures explicit tracking - encryption coverage is either present or explicitly deferred.
  </action>
  <verify>
```bash
ls test_*.sh 2>/dev/null || echo "All bash scripts deleted"
```
Should output "All bash scripts deleted".
  </verify>
  <done>All test_*.sh scripts are deleted</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Go-based test infrastructure replacing bash scripts:
- IncusFixture for VM lifecycle management
- Cleanup utilities for orphaned resource removal
- Snapshot-based test reset
- Golden file testing for CLI output
- All tests migrated from bash to Go
  </what-built>
  <how-to-verify>
Run both test targets 3 times consecutively and verify:

1. **Integration tests (non-VM):**
```bash
make test-integration
```
Should pass (existing Go tests, no incus required).

2. **First VM test run:**
```bash
sudo make test-incus
```
Record result (pass/fail) and time.

3. **Second VM test run (immediately after):**
```bash
sudo make test-incus
```
Verify no leftover resources affected the run.

4. **Third VM test run:**
```bash
sudo make test-incus
```
All three runs should pass.

5. **Verify cleanup:**
```bash
incus list | grep nbc-test
incus storage volume list default | grep nbc-test
```
Both should show no results (no orphaned resources).

6. **Verify golden files work:**
```bash
go test ./pkg/... -run TestCLI_
```
Should pass. Then change a help string temporarily and verify test fails.

Note: The Makefile update in Task 1 ensures `make test-incus` calls the Go tests
(which internally run integration tests). The `test-integration` target remains
for non-VM integration tests that don't require incus.
  </how-to-verify>
  <resume-signal>
Report results:
- "test-integration pass, test-incus 3x pass, no orphans" - Phase complete
- Describe any issues for debugging
  </resume-signal>
</task>

</tasks>

<verification>
1. `make test-incus` runs Go tests
2. All bash test scripts deleted
3. `make test-integration` still works (existing Go tests)
4. No orphaned nbc-test-* resources after any test run
5. 3 consecutive test runs pass
</verification>

<success_criteria>
Phase 1 complete when:
- `make test-integration` passes 3 consecutive runs with 0 failures
- Each test leaves no orphaned VMs, volumes, or mounts
- Tests timeout cleanly with actionable error messages
- VM tests reset via snapshots between test cases
- CLI output changes are caught by golden file comparison
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-reliability/01-06-SUMMARY.md`
</output>
