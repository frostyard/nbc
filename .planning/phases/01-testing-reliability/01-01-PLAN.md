---
phase: 01-testing-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - pkg/testutil/timeouts.go
autonomous: true

must_haves:
  truths:
    - "Incus Go client is available for import"
    - "Goldie library is available for golden file testing"
    - "Timeout constants are defined for unit, integration, and VM tests"
  artifacts:
    - path: "go.mod"
      provides: "Incus and goldie dependencies"
      contains: "github.com/lxc/incus/v6"
    - path: "go.sum"
      provides: "Dependency checksums"
    - path: "pkg/testutil/timeouts.go"
      provides: "Test timeout constants"
      exports: ["TimeoutUnit", "TimeoutIntegration", "TimeoutVM", "TimeoutVMBoot"]
  key_links: []
---

<objective>
Add test infrastructure dependencies and define timeout constants for deterministic test execution.

Purpose: Enable subsequent plans to use Incus Go client and goldie for structured test infrastructure.
Output: Updated go.mod with new dependencies, timeout constants file.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-testing-reliability/01-RESEARCH.md
@pkg/testutil/disk.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test infrastructure dependencies</name>
  <files>go.mod, go.sum</files>
  <action>
Add the Incus Go client and goldie golden file testing library as dependencies:

```bash
go get github.com/lxc/incus/v6/client@v6.21.0
go get github.com/sebdah/goldie/v2@v2.8.0
go mod tidy
```

The Incus client provides programmatic VM management. Goldie provides golden file testing with -update flag support, colored diffs, and testdata directory conventions.
  </action>
  <verify>
```bash
go list -m github.com/lxc/incus/v6
go list -m github.com/sebdah/goldie/v2
```
Both commands should succeed and show the module versions.
  </verify>
  <done>go.mod contains both dependencies, go mod tidy succeeds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create timeout constants</name>
  <files>pkg/testutil/timeouts.go</files>
  <action>
Create `pkg/testutil/timeouts.go` with structured timeout constants for different test types:

```go
package testutil

import "time"

// Test timeout constants by test type.
// Use these with context.WithTimeout for consistent, explicit timeouts.
const (
    // TimeoutUnit is for unit tests (no I/O, no external dependencies)
    TimeoutUnit = 30 * time.Second

    // TimeoutIntegration is for integration tests (disk operations, container builds)
    TimeoutIntegration = 2 * time.Minute

    // TimeoutVM is the overall timeout for VM-based tests
    TimeoutVM = 10 * time.Minute

    // TimeoutVMBoot is specifically for waiting for VM boot completion
    TimeoutVMBoot = 2 * time.Minute

    // TimeoutVMInstall is for nbc install operations inside VM
    TimeoutVMInstall = 15 * time.Minute

    // TimeoutOperation is the default timeout for individual Incus operations
    TimeoutOperation = 60 * time.Second
)
```

These constants calibrate test expectations and provide actionable timeout messages.
  </action>
  <verify>
```bash
go build ./pkg/testutil/...
```
Build should succeed with no errors.
  </verify>
  <done>pkg/testutil/timeouts.go exists with all timeout constants, package compiles</done>
</task>

</tasks>

<verification>
1. `go mod tidy` completes without errors
2. `go build ./pkg/testutil/...` succeeds
3. New dependencies visible in go.mod
4. Timeout constants importable from other packages
</verification>

<success_criteria>
- Incus client v6.21.0+ in go.mod
- Goldie v2.8.0+ in go.mod
- TimeoutUnit, TimeoutIntegration, TimeoutVM, TimeoutVMBoot constants defined
- All code compiles
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-reliability/01-01-SUMMARY.md`
</output>
