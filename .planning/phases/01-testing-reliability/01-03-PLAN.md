---
phase: 01-testing-reliability
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - pkg/testutil/incus.go
  - pkg/testutil/cleanup.go
autonomous: true

must_haves:
  truths:
    - "Orphaned nbc-test-* resources are cleaned before test suite runs"
    - "Snapshots can be created and restored for VM state reset"
    - "Diagnostic dump captures console output, mounts, and network on failure"
    - "Timeout errors include last action and duration"
  artifacts:
    - path: "pkg/testutil/cleanup.go"
      provides: "Suite-level cleanup utilities"
      exports: ["CleanupOrphanedResources", "CleanupAllNbcTestResources"]
      min_lines: 50
    - path: "pkg/testutil/incus.go"
      provides: "Extended fixture with snapshots and diagnostics"
      exports: ["CreateBaselineSnapshot", "ResetToSnapshot", "DumpDiagnostics"]
  key_links:
    - from: "pkg/testutil/cleanup.go"
      to: "github.com/lxc/incus/v6/client"
      via: "ConnectIncusUnix for resource listing"
      pattern: "incus\\.ConnectIncusUnix"
    - from: "pkg/testutil/incus.go"
      to: "api.InstanceSnapshotsPost"
      via: "CreateInstanceSnapshot"
      pattern: "CreateInstanceSnapshot"
---

<objective>
Add cleanup utilities, snapshot management, and diagnostic dumping to the test infrastructure.

Purpose: Enable deterministic test execution with clean state, fast resets via snapshots, and actionable failure diagnostics.
Output: Extended incus.go with snapshot/diagnostic methods, new cleanup.go for suite-level cleanup.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-testing-reliability/01-RESEARCH.md
@.planning/phases/01-testing-reliability/01-CONTEXT.md
@pkg/testutil/incus.go
@pkg/testutil/disk.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add snapshot and diagnostic methods to IncusFixture</name>
  <files>pkg/testutil/incus.go</files>
  <action>
Extend pkg/testutil/incus.go with snapshot management and diagnostic dumping:

**Snapshot Methods:**
1. **CreateBaselineSnapshot(name string) error**: 
   - Create non-stateful snapshot via api.InstanceSnapshotsPost
   - Default name: "baseline"
   - Call immediately after VM boot, before any test operations
   
2. **ResetToSnapshot(name string) error**:
   - Stop VM if running (force stop)
   - Restore via api.InstancePut with Restore field
   - Start VM again
   - Wait for ready (use WaitForReady with TimeoutVMBoot)
   - Per CONTEXT.md: Reset before EVERY test function, not per-suite

**Diagnostic Dump (per CONTEXT.md decisions):**
3. **DumpDiagnostics(reason string)**:
   - Create test-failures/ directory if needed
   - Log file: test-failures/{testName}_{timestamp}.log
   - Capture:
     - Last 50 lines of console output (via GetConsole API if available, or exec `journalctl -n 50`)
     - Mounted volumes: `findmnt -l`
     - Network state: `ip addr`
   - Write to log file
   - Log summary inline: last 10 lines of console + log file path
   - Include reason in log (e.g., "timeout after 60s waiting for VM boot")

**Timeout-aware waiting:**
4. Update **WaitForReady** to include last action in timeout error:
   - Track what we're waiting for
   - On timeout, return error like: "timed out after 2m0s waiting for systemctl is-system-running"
  </action>
  <verify>
```bash
go build ./pkg/testutil/...
```
Build should succeed.
  </verify>
  <done>
IncusFixture has CreateBaselineSnapshot, ResetToSnapshot, DumpDiagnostics methods.
WaitForReady returns actionable timeout errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create suite-level cleanup utilities</name>
  <files>pkg/testutil/cleanup.go</files>
  <action>
Create `pkg/testutil/cleanup.go` for suite-level resource cleanup:

1. **CleanupOrphanedResources(t *testing.T)**:
   - Connect to Incus
   - List all instances matching "nbc-test-*"
   - For each: force stop, delete (silent, ignore errors)
   - List all storage volumes matching "nbc-test-*"
   - For each: delete (silent, ignore errors)
   - Per CONTEXT.md: Silent cleanup, no fail, no warn

2. **CleanupAllNbcTestResources()**:
   - Non-test version for use in TestMain
   - Same behavior but no *testing.T required
   - Returns error only if cannot connect to Incus

3. **TestMain helper pattern** (document in comments):
```go
// In test file:
// func TestMain(m *testing.M) {
//     testutil.CleanupAllNbcTestResources() // Clean slate
//     code := m.Run()
//     testutil.CleanupAllNbcTestResources() // Final cleanup
//     os.Exit(code)
// }
```

4. **CleanupOrphanedMounts(pattern string)**:
   - Find mounts matching pattern (e.g., "/mnt/nbc-test-*")
   - Force unmount each (umount -f)
   - Silent on error
  </action>
  <verify>
```bash
go build ./pkg/testutil/...
```
Build should succeed.
  </verify>
  <done>
cleanup.go exports CleanupOrphanedResources, CleanupAllNbcTestResources, CleanupOrphanedMounts.
All functions are silent on cleanup errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add test-failures to .gitignore</name>
  <files>.gitignore</files>
  <action>
Add test-failures/ directory to .gitignore (if not already present):

```
# Test failure diagnostics
test-failures/
```

This directory contains diagnostic logs from failed tests and should not be committed.
  </action>
  <verify>
```bash
grep -q "test-failures" .gitignore && echo "Found" || echo "Not found"
```
Should output "Found".
  </verify>
  <done>test-failures/ is gitignored</done>
</task>

</tasks>

<verification>
1. `go build ./pkg/testutil/...` succeeds
2. IncusFixture has snapshot methods: CreateBaselineSnapshot, ResetToSnapshot
3. DumpDiagnostics creates log files in test-failures/
4. Cleanup utilities silently remove orphaned resources
5. test-failures/ is in .gitignore
</verification>

<success_criteria>
- Snapshot creation and restoration work via Incus API
- Diagnostics capture console, mounts, network state
- Cleanup is silent (no warnings/errors on cleanup failures)
- TestMain pattern documented for clean slate execution
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-reliability/01-03-SUMMARY.md`
</output>
