---
phase: 01-testing-reliability
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - pkg/incus_test.go
  - pkg/cli_test.go
  - pkg/testdata/*.golden
autonomous: true

must_haves:
  truths:
    - "A/B update test runs in Go test infrastructure"
    - "Boot test validates installed system boots correctly"
    - "CLI output tests use golden file comparison"
    - "All VM tests use snapshot reset between cases"
  artifacts:
    - path: "pkg/incus_test.go"
      provides: "Complete VM test suite"
      exports: ["TestIncus_Install", "TestIncus_Update", "TestIncus_Boot"]
      min_lines: 300
    - path: "pkg/cli_test.go"
      provides: "CLI golden file tests"
      exports: ["TestCLI_ListOutput", "TestCLI_HelpOutput"]
    - path: "pkg/testdata"
      provides: "Golden files directory"
  key_links:
    - from: "pkg/incus_test.go"
      to: "fixture.ResetToSnapshot"
      via: "t.Run with reset"
      pattern: "ResetToSnapshot"
    - from: "pkg/cli_test.go"
      to: "testutil.AssertGolden"
      via: "golden comparison"
      pattern: "AssertGolden"
---

<objective>
Complete VM test migration (update, boot tests) and add CLI golden file tests.

Purpose: Migrate remaining tests from bash to Go, achieving full test coverage with deterministic execution.
Output: Extended incus_test.go with all VM tests, cli_test.go with golden file tests, testdata/ with golden files.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-testing-reliability/01-RESEARCH.md
@.planning/phases/01-testing-reliability/01-CONTEXT.md
@pkg/incus_test.go
@pkg/testutil/golden.go
@test_incus.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add A/B update and boot tests</name>
  <files>pkg/incus_test.go</files>
  <action>
Extend pkg/incus_test.go with remaining VM tests from test_incus.sh:

**TestIncus_Update** - A/B update test:
- Requires TestIncus_Install to pass (or run after install in same test)
- Run `nbc update --device $TEST_DISK` 
- Verify root2 partition has content after update
- Verify both A/B partitions have files
- Uses snapshot reset if running as separate test

**TestIncus_Boot** - Boot verification:
- Detach disk from test VM
- Create empty VM with disk as boot device
- Start VM and wait for boot (use TimeoutVMBoot)
- Verify /etc overlay is mounted
- Verify rd.etc.overlay in kernel cmdline
- Verify root is read-only

**TestIncus_FullCycle** - Combined test (optional, for CI):
- Single test that does: install -> verify -> update -> verify -> boot -> verify
- Avoids overhead of multiple VM creations
- Uses subtests with t.Run for each phase

Structure with subtests and snapshot resets:
```go
func TestIncus_FullCycle(t *testing.T) {
    // ... setup fixture ...
    
    t.Run("Install", func(t *testing.T) {
        // Install test
    })
    
    t.Run("VerifyPartitions", func(t *testing.T) {
        // Partition verification
    })
    
    t.Run("Update", func(t *testing.T) {
        // A/B update
    })
    
    t.Run("Boot", func(t *testing.T) {
        // Boot from installed disk
    })
}
```

Per CONTEXT.md: Reset VM to snapshot before every test function. For subtests sharing state (install -> update), skip reset between related subtests but reset at start of each top-level test.
  </action>
  <verify>
```bash
go build ./pkg/...
```
Build should succeed.
  </verify>
  <done>incus_test.go has TestIncus_Update, TestIncus_Boot, or TestIncus_FullCycle covering all scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI golden file tests</name>
  <files>pkg/cli_test.go, pkg/testdata/</files>
  <action>
Create `pkg/cli_test.go` for CLI output golden file testing:

```go
package pkg

import (
    "bytes"
    "os/exec"
    "testing"
    
    "github.com/frostyard/nbc/pkg/testutil"
)

func TestCLI_HelpOutput(t *testing.T) {
    // Capture nbc --help output
    cmd := exec.Command("./nbc", "--help")
    var stdout bytes.Buffer
    cmd.Stdout = &stdout
    cmd.Run() // Ignore exit code, help may exit 0 or 1
    
    output := testutil.NormalizeOutput(stdout.String())
    testutil.AssertGolden(t, "help", []byte(output))
}

func TestCLI_ListHelpOutput(t *testing.T) {
    cmd := exec.Command("./nbc", "list", "--help")
    var stdout bytes.Buffer
    cmd.Stdout = &stdout
    cmd.Run()
    
    output := testutil.NormalizeOutput(stdout.String())
    testutil.AssertGolden(t, "list-help", []byte(output))
}

func TestCLI_InstallHelpOutput(t *testing.T) {
    cmd := exec.Command("./nbc", "install", "--help")
    var stdout bytes.Buffer
    cmd.Stdout = &stdout
    cmd.Run()
    
    output := testutil.NormalizeOutput(stdout.String())
    testutil.AssertGolden(t, "install-help", []byte(output))
}

func TestCLI_VersionOutput(t *testing.T) {
    cmd := exec.Command("./nbc", "version")
    var stdout bytes.Buffer
    cmd.Stdout = &stdout
    cmd.Run()
    
    output := testutil.NormalizeOutput(stdout.String())
    testutil.AssertGolden(t, "version", []byte(output))
}
```

Create initial golden files:
1. Create `pkg/testdata/` directory
2. Run `go test -update ./pkg/... -run TestCLI_` to generate golden files
3. Verify golden files are reasonable

Golden files capture CLI help text and output format. When CLI changes intentionally, run with -update to regenerate.
  </action>
  <verify>
```bash
mkdir -p pkg/testdata
go build ./pkg/...
```
Build should succeed. Testdata directory created.
  </verify>
  <done>cli_test.go has golden file tests for help output, pkg/testdata/ exists for golden files</done>
</task>

<task type="auto">
  <name>Task 3: Generate initial golden files</name>
  <files>pkg/testdata/*.golden</files>
  <action>
Generate the initial golden files by running the tests with -update flag:

1. Build nbc: `make build`
2. Run: `go test -update ./pkg/... -run TestCLI_`
3. Verify golden files created in pkg/testdata/

Expected files:
- pkg/testdata/help.golden
- pkg/testdata/list-help.golden
- pkg/testdata/install-help.golden
- pkg/testdata/version.golden

Review the generated files to ensure they look correct (contain help text, not errors).
  </action>
  <verify>
```bash
ls pkg/testdata/*.golden 2>/dev/null | wc -l
```
Should show 4 or more files.
  </verify>
  <done>Golden files exist in pkg/testdata/ with reasonable content</done>
</task>

</tasks>

<verification>
1. `go build ./pkg/...` succeeds
2. `go test ./pkg/... -run TestCLI_` passes (golden files match)
3. TestIncus_Update or TestIncus_FullCycle covers A/B update
4. Boot verification checks /etc overlay mount
5. Golden files capture current CLI output
</verification>

<success_criteria>
- All VM tests from test_incus.sh are migrated to Go
- A/B update test verifies both root partitions
- Boot test verifies /etc overlay and read-only root
- CLI golden tests detect output changes
- `go test -update` regenerates golden files
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-reliability/01-05-SUMMARY.md`
</output>
